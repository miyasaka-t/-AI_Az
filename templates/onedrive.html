<!doctype html>
<meta charset="utf-8" />
<title>OneDrive ä¿å­˜ï¼ˆå€‹äºº/çµ„ç¹” ä¸¡å¯¾å¿œï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font:14px/1.6 system-ui; max-width:820px; margin:24px auto; }
  .row { display:flex; gap:8px; margin:10px 0; align-items:center; flex-wrap:wrap; }
  input[type=text]{ flex:1; padding:8px; }
  button { padding:10px 12px; border:1px solid #ccc; border-radius:10px; cursor:pointer; }
  #log { white-space:pre-wrap; background:#fafafa; border:1px solid #eee; padding:12px; min-height:120px;}
  .muted { color:#666 }
  .badge { padding:2px 8px; border-radius:999px; background:#eef; color:#224; font-weight:600; }
  .hide { display:none; }
</style>

<h1>OneDrive ä¿å­˜ <span id="modeBadge" class="badge"></span></h1>
<p>URL ã‚¯ã‚¨ãƒªã§ <code>?mode=personal</code>ï¼ˆæ—¢å®šï¼‰ã¾ãŸã¯ <code>?mode=org</code> ã‚’æŒ‡å®šã€‚</p>

<!-- å…±é€šï¼šãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆemlç”¨ã®æ¨å¥¨åï¼‰ -->
<div class="row">
  <label>æ¨å¥¨ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä»»æ„ãƒ».emlç”¨ï¼‰</label>
  <input id="name" type="text" placeholder="Report.eml">
</div>

<!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆ3ã¤ï¼‰ -->
<div class="row">
  <label><input type="checkbox" id="cb_eml"> 1) LLMå‡ºåŠ›ï¼ˆ.emlï¼‰</label>
  <span id="nm_eml" class="muted"></span>
</div>
<div class="row">
  <label><input type="checkbox" id="cb_xlsx"> 2) æ·»ä»˜ã‚¨ã‚¯ã‚»ãƒ«ï¼ˆ.xlsx/.csv ã® ticketï¼‰</label>
  <span id="nm_xlsx" class="muted"></span>
</div>
<div class="row">
  <label><input type="checkbox" id="cb_msg"> 3) .msg åŸæ–‡</label>
  <span id="nm_msg" class="muted"></span>
</div>

<!-- å€‹äººç”¨ UIï¼šãƒ•ã‚©ãƒ«ãƒ€1å›é¸æŠ â†’ ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
<div id="personalPanel">
  <div class="row">
    <button id="pickPersonal">ğŸ“ å€‹äººOneDriveã®ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã¶</button>
    <span id="pickedHintPersonal"></span>
  </div>
  <div class="row">
    <button id="uploadPersonal" disabled>â¬† ï¼ˆå€‹äººï¼‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ</button>
    <span class="muted">â€»é¸ã‚“ã 1ã¤ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ã€ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®é …ç›®ã‚’å…¨ã¦ä¿å­˜</span>
  </div>
</div>

<!-- çµ„ç¹”ç”¨ UIï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰ -->
<div id="orgPanel" class="hide">
  <div class="row">
    <button id="pick">ğŸ“ çµ„ç¹”OneDriveã®ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã¶</button>
    <span id="pickedHint"></span>
  </div>
  <div class="row">
    <button id="upload" disabled>â¬† ï¼ˆçµ„ç¹”ï¼‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ</button>
  </div>
</div>

<h3>ãƒ­ã‚°</h3>
<pre id="log"></pre>

<!-- OneDrive File Picker v7.2 -->
<script src="https://js.live.net/v7.2/OneDrive.js"></script>
<script>
const q = new URLSearchParams(location.search);

// ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¢å®š personalï¼‰
const MODE = (q.get("mode") || "personal").toLowerCase();
document.getElementById("modeBadge").textContent = MODE === "org" ? "çµ„ç¹”ãƒ¢ãƒ¼ãƒ‰" : "å€‹äººãƒ¢ãƒ¼ãƒ‰";
document.getElementById("personalPanel").classList.toggle("hide", MODE !== "personal");
document.getElementById("orgPanel").classList.toggle("hide", MODE !== "org");

// å—ã‘å–ã‚‹ãƒã‚±ãƒƒãƒˆ
const T_EML   = q.get("ticket_eml")   || "";
const T_XLSX  = q.get("ticket_xlsx")  || "";
const T_MSG   = q.get("ticket_msg")   || "";
const TICKET_SINGLE = q.get("ticket") || "";
const SUGGEST = q.get("suggest") || "Report.eml";
document.getElementById("name").value = SUGGEST;

// è‡ªã‚ªãƒªã‚¸ãƒ³ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
const BASE = location.origin;
const EP_PEEK          = BASE + "/tickets/peek";
const EP_DRIVEITEM     = BASE + "/api/drive/item";
const EP_UPLOAD_ORG    = BASE + "/api/upload";             // çµ„ç¹”
const EP_UPLOAD_ORG_XL = BASE + "/api/upload-msg-xlsx";    // çµ„ç¹”(.msgâ†’xlsx)
const EP_UPLOAD_PSN    = BASE + "/api/upload-personal";    // â˜…å€‹äººï¼ˆæ–°è¦ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…å¿…é ˆï¼‰

// OneDrive Picker ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDï¼ˆç½®æ›æ¸ˆã¿ï¼‰
const FRONT_CLIENT_ID = "4be5eab6-df8a-4990-b738-be8b2b0ba842";

let pickedFolderId = null;        // çµ„ç¹”
let pickedFolderIdPersonal = null;// å€‹äºº

const log  = (m)=> document.getElementById("log").textContent += m + "\n";

// peek ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const peekCache = {};
async function peekTicket(ticket) {
  if (!ticket) return null;
  if (peekCache[ticket]) return peekCache[ticket];
  const r = await fetch(EP_PEEK + "?ticket=" + encodeURIComponent(ticket));
  const j = await r.json();
  if (!r.ok) throw new Error(j.error || r.statusText);
  const info = { fileName: j.fileName || "", type: (j.type || "text").toLowerCase() };
  peekCache[ticket] = info;
  return info;
}

// åˆæœŸ peek
(async function initPeek(){
  try {
    if (T_EML || TICKET_SINGLE) {
      const t = T_EML || TICKET_SINGLE;
      const pe = await peekTicket(t);
      document.getElementById("nm_eml").textContent = `â†’ ${pe.fileName || "(åå‰æœªè¨­å®š)"} [${pe.type}]`;
      document.getElementById("cb_eml").checked = true;
      const nm = document.getElementById("name").value.trim() || pe.fileName || "message.eml";
      document.getElementById("name").value = nm.toLowerCase().endsWith(".eml") ? nm : (nm + ".eml");
    } else {
      document.getElementById("cb_eml").disabled = true;
      document.getElementById("nm_eml").textContent = "(ticket_eml ãŒæœªæŒ‡å®š)";
    }
    if (T_XLSX) {
      const px = await peekTicket(T_XLSX);
      document.getElementById("nm_xlsx").textContent = `â†’ ${px.fileName || "(åå‰æœªè¨­å®š)"} [${px.type}]`;
      document.getElementById("cb_xlsx").checked = true;
    } else {
      document.getElementById("cb_xlsx").disabled = true;
      document.getElementById("nm_xlsx").textContent = "(ticket_xlsx ãŒæœªæŒ‡å®š)";
    }
    if (T_MSG) {
      const pm = await peekTicket(T_MSG);
      document.getElementById("nm_msg").textContent = `â†’ ${pm.fileName || "(åå‰æœªè¨­å®š)"} [${pm.type}]`;
      document.getElementById("cb_msg").checked = true;
    } else {
      document.getElementById("cb_msg").disabled = true;
      document.getElementById("nm_msg").textContent = "(ticket_msg ãŒæœªæŒ‡å®š)";
    }
    if (!T_EML && !T_XLSX && !T_MSG && TICKET_SINGLE) {
      const p1 = await peekTicket(TICKET_SINGLE);
      document.getElementById("nm_eml").textContent = `â†’ ${p1.fileName || "(åå‰æœªè¨­å®š)"} [${p1.type}]`;
      document.getElementById("cb_eml").checked = true;
    }
  } catch(e) {
    log("peekä¾‹å¤–: " + e.message);
  }
})();

/* =======================
   å€‹äººãƒ¢ãƒ¼ãƒ‰ï¼šãƒ•ã‚©ãƒ«ãƒ€é¸æŠ â†’ ä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
   ======================= */
document.getElementById("pickPersonal").onclick = () => {
  if (!FRONT_CLIENT_ID) { alert("FRONT_CLIENT_ID æœªè¨­å®š"); return; }
  const odOptions = {
    clientId: FRONT_CLIENT_ID,
    action: "query",
    viewType: "folders",
    multiSelect: false,
    openInNewWindow: true,
    advanced: {
      endpointHint: "api.onedrive.com",
      redirectUri: location.origin + "/picker-redirect.html"
    },
    success: async function(res) {
      const it = (res.value && res.value[0]) || null;
      if (!it || !it.id || !it.folder) { log("âŒ ãƒ•ã‚©ãƒ«ãƒ€æœªé¸æŠ(å€‹äºº)"); return; }
      pickedFolderIdPersonal = it.id;
      document.getElementById("pickedHintPersonal").textContent = "é¸æŠä¸­: " + (it.name || it.id);
      log("Pick OK (personal): folderId=" + pickedFolderIdPersonal);
      document.getElementById("uploadPersonal").disabled = false;
    },
    cancel: function(){ log("ã‚­ãƒ£ãƒ³ã‚»ãƒ«(å€‹äºº)"); },
    error:  function(e){ log("âŒ ã‚¨ãƒ©ãƒ¼(å€‹äººPicker): " + JSON.stringify(e)); }
  };
  OneDrive.open(odOptions);
};

async function uploadPersonalOne(ticket, nameOverride) {
  const fd = new FormData();
  fd.append("ticket", ticket);
  fd.append("folderId", pickedFolderIdPersonal);
  if (nameOverride) fd.append("fileName", nameOverride);
  const r = await fetch(EP_UPLOAD_PSN, { method: "POST", body: fd });
  const j = await r.json().catch(()=> ({}));
  return { ok: r.ok, status: r.status, body: j };
}

document.getElementById("uploadPersonal").onclick = async () => {
  if (MODE !== "personal") { alert("ä»Šã¯çµ„ç¹”ãƒ¢ãƒ¼ãƒ‰ã§ã™"); return; }
  if (!pickedFolderIdPersonal) { alert("å…ˆã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }

  const want_eml  = document.getElementById("cb_eml").checked && (T_EML || TICKET_SINGLE);
  const want_xlsx = document.getElementById("cb_xlsx").checked && T_XLSX;
  const want_msg  = document.getElementById("cb_msg").checked && T_MSG;
  if (!want_eml && !want_xlsx && !want_msg) { alert("ä¿å­˜ã™ã‚‹é …ç›®ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„"); return; }

  // eml ã®å‘½åè£œæ­£
  let nm = (document.getElementById("name").value || SUGGEST).trim();
  if (want_eml && nm && !nm.toLowerCase().endsWith(".eml")) {
    nm = nm + ".eml"; document.getElementById("name").value = nm;
  }

  document.getElementById("uploadPersonal").disabled = true;
  try {
    if (want_eml) {
      const ticket = T_EML || TICKET_SINGLE;
      log("â†’ å€‹äºº: .eml ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹");
      const r = await uploadPersonalOne(ticket, nm || undefined);
      log(r.ok ? `âœ… å®Œäº†(.eml): ${r.body.webUrl || ""}` : `âŒ å¤±æ•—(.eml): ${r.status} ${JSON.stringify(r.body)}`);
    }
    if (want_xlsx) {
      log("â†’ å€‹äºº: xlsx ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹");
      const r = await uploadPersonalOne(T_XLSX, undefined);
      log(r.ok ? `âœ… å®Œäº†(Excel): ${r.body.webUrl || ""}` : `âŒ å¤±æ•—(Excel): ${r.status} ${JSON.stringify(r.body)}`);
    }
    if (want_msg) {
      log("â†’ å€‹äºº: .msg åŸæ–‡ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹");
      const r = await uploadPersonalOne(T_MSG, undefined);
      log(r.ok ? `âœ… å®Œäº†(.msg): ${r.body.webUrl || ""}` : `âŒ å¤±æ•—(.msg): ${r.status} ${JSON.stringify(r.body)}`);
    }
  } catch(e) {
    log("âŒ ä¾‹å¤–(å€‹äºº): " + e.message);
  } finally {
    document.getElementById("uploadPersonal").disabled = false;
  }
};

/* =======================
   çµ„ç¹”ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰
   ======================= */
document.getElementById("pick").onclick = () => {
  if (!FRONT_CLIENT_ID) { alert("FRONT_CLIENT_ID æœªè¨­å®š"); return; }
  const odOptions = {
    clientId: FRONT_CLIENT_ID, action: "query", viewType: "folders", multiSelect: false, openInNewWindow: true,
    advanced: { endpointHint: "graph.microsoft.com", redirectUri: location.origin + "/picker-redirect.html" },
    success: async function(res) {
      const it = (res.value && res.value[0]) || null;
      if (!it || !it.id || !it.folder) { log("âŒ ãƒ•ã‚©ãƒ«ãƒ€æœªé¸æŠ"); return; }
      pickedFolderId = it.id;
      document.getElementById("pickedHint").textContent = "é¸æŠä¸­: " + (it.name || it.id);
      log("Pick OK: folderId=" + pickedFolderId);
      document.getElementById("upload").disabled = false;
    },
    cancel: function(){ log("ã‚­ãƒ£ãƒ³ã‚»ãƒ«(çµ„ç¹”)"); },
    error:  function(e){ log("âŒ ã‚¨ãƒ©ãƒ¼(çµ„ç¹”): " + JSON.stringify(e)); }
  };
  OneDrive.open(odOptions);
};

async function uploadOne(endpoint, ticket, nameOverride) {
  const fd = new FormData();
  fd.append("ticket", ticket);
  fd.append("folderId", pickedFolderId);
  if (nameOverride) fd.append("fileName", nameOverride);
  const r = await fetch(endpoint, { method: "POST", body: fd });
  const j = await r.json().catch(()=> ({}));
  return { ok: r.ok, status: r.status, body: j };
}

document.getElementById("upload").onclick = async () => {
  if (MODE !== "org") { alert("ä»Šã¯å€‹äººãƒ¢ãƒ¼ãƒ‰ã§ã™"); return; }
  if (!pickedFolderId) { alert("å…ˆã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }

  const want_eml  = document.getElementById("cb_eml").checked && (T_EML || TICKET_SINGLE);
  const want_xlsx = document.getElementById("cb_xlsx").checked && T_XLSX;
  const want_msg  = document.getElementById("cb_msg").checked && T_MSG;
  if (!want_eml && !want_xlsx && !want_msg) { alert("ä¿å­˜ã™ã‚‹é …ç›®ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„"); return; }

  let nm = (document.getElementById("name").value || SUGGEST).trim();
  if (want_eml && nm && !nm.toLowerCase().endsWith(".eml")) {
    nm = nm + ".eml"; document.getElementById("name").value = nm;
  }

  document.getElementById("upload").disabled = true;
  try {
    if (want_eml) {
      const ticket = T_EML || TICKET_SINGLE;
      log("â†’ çµ„ç¹”: .eml ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹");
      const r = await uploadOne(EP_UPLOAD_ORG, ticket, nm || undefined);
      log(r.ok ? `âœ… å®Œäº†(.eml): ${r.body.webUrl || ""}` : `âŒ å¤±æ•—(.eml): ${r.status} ${JSON.stringify(r.body)}`);
    }
    if (want_xlsx) {
      log("â†’ çµ„ç¹”: xlsx ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹");
      const r = await uploadOne(EP_UPLOAD_ORG_XL, T_MSG, undefined); // .msg â†’ xlsx æŠ½å‡ºã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      log(r.ok ? `âœ… å®Œäº†(Excel): ${r.body.webUrl || ""}` : `âŒ å¤±æ•—(Excel): ${r.status} ${JSON.stringify(r.body)}`);
    }
    if (want_msg) {
      log("â†’ çµ„ç¹”: .msg åŸæ–‡ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹");
      const r = await uploadOne(EP_UPLOAD_ORG, T_MSG, undefined);
      log(r.ok ? `âœ… å®Œäº†(.msg): ${r.body.webUrl || ""}` : `âŒ å¤±æ•—(.msg): ${r.status} ${JSON.stringify(r.body)}`);
    }
  } catch(e) {
    log("âŒ ä¾‹å¤–(çµ„ç¹”): " + e.message);
  } finally {
    document.getElementById("upload").disabled = false;
  }
};
</script>
