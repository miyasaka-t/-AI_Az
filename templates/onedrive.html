<!doctype html>
<meta charset="utf-8" />
<title>OneDriveï¼ˆå€‹äººï¼‰ã«ä¿å­˜</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font:14px/1.6 system-ui; max-width:780px; margin:24px auto; }
  .row { display:flex; gap:8px; margin:10px 0; align-items:center; flex-wrap:wrap; }
  input[type=text]{ flex:1; padding:8px; }
  button { padding:10px 12px; border:1px solid #ccc; border-radius:10px; cursor:pointer; }
  #log { white-space:pre-wrap; background:#fafafa; border:1px solid #eee; padding:12px; min-height:80px;}
  .muted { color:#666 }
</style>

<h1>OneDriveï¼ˆå€‹äººï¼‰ã«ä¿å­˜</h1>
<p>1) ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã‚“ã§ â†’ 2) ä¿å­˜ã—ãŸã„é …ç›®ã‚’ãƒã‚§ãƒƒã‚¯ â†’ 3) ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>

<!-- ãƒ•ã‚¡ã‚¤ãƒ«åå…±é€šä¸Šæ›¸ãï¼ˆæœªå…¥åŠ›ãªã‚‰å„ticketã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã‚’ä½¿ç”¨ï¼‰ -->
<div class="row">
  <label>ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä»»æ„ï¼‰</label>
  <input id="name" type="text" placeholder="Report.txt">
</div>

<!-- 3ã¤ã®ä¿å­˜å¯¾è±¡ã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠ -->
<div class="row">
  <label><input type="checkbox" id="cb_eml"> 1) LLMå‡ºåŠ›ï¼ˆ.emlï¼‰</label>
  <span id="nm_eml" class="muted"></span>
</div>
<div class="row">
  <label><input type="checkbox" id="cb_xlsx"> 2) æ·»ä»˜ã‚¨ã‚¯ã‚»ãƒ«ï¼ˆ.msgå†…ã®Excelï¼‰</label>
  <span id="nm_xlsx" class="muted"></span>
</div>
<div class="row">
  <label><input type="checkbox" id="cb_msg"> 3) .msg åŸæ–‡ï¼ˆExcelæ·»ä»˜å…¥ã‚Šï¼‰</label>
  <span id="nm_msg" class="muted"></span>
</div>

<div class="row">
  <button id="pick">ğŸ“ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã¶</button>
  <span id="pickedHint"></span>
</div>

<div class="row">
  <button id="upload" disabled>â¬† ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
</div>

<h3>ãƒ­ã‚°</h3>
<pre id="log"></pre>

<!-- OneDrive File Picker v7.2 -->
<script src="https://js.live.net/v7.2/OneDrive.js"></script>
<script>
const q = new URLSearchParams(location.search);

// å—ã‘å–ã‚‹ãƒã‚±ãƒƒãƒˆï¼ˆè¤‡æ•°ï¼‰
const T_EML  = q.get("ticket_eml")  || "";
const T_MSG  = q.get("ticket_msg")  || "";
// ï¼ˆå¿…è¦ãªã‚‰ï¼‰Excelå˜ç‹¬ticketã‚‚å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ï¼šconst T_XLSX = q.get("ticket_xlsx") || "";

const SUGGEST = q.get("suggest") || "download.txt";
document.getElementById("name").value = SUGGEST;

// â˜…æœ¬ç•ªå€¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦ç½®æ›ï¼‰
const RENDER_BASE = "https://ai-az.onrender.com";
const FRONT_CLIENT_ID = "4be5eab6-df8a-4990-b738-be8b2b0ba842";
const RENDER_UPLOAD_ENDPOINT      = RENDER_BASE + "/api/upload";           // åŸæ–‡/æ±ç”¨
const RENDER_PEEK_ENDPOINT        = RENDER_BASE + "/tickets/peek";         // äº‹å‰è¡¨ç¤º
const RENDER_UPLOAD_MSG_XLSX_EP   = RENDER_BASE + "/api/upload-msg-xlsx";  // æ–°è¦ï¼š.msgâ†’xlsx ä¿å­˜

let pickedFolderId = null;
// å‚è€ƒç”¨ï¼šå˜ä½“ãƒ¢ãƒ¼ãƒ‰äº’æ›
const TICKET_SINGLE = q.get("ticket") || "";

// ãƒ­ã‚° & ãƒ’ãƒ³ãƒˆ
const log  = (m)=> document.getElementById("log").textContent += m + "\n";
const hint = (m)=> document.getElementById("pickedHint").textContent = m;

// ãƒã‚±ãƒƒãƒˆã®ä¸­èº«ã‚’ peek ã—ã¦ UI ã«åæ˜ 
async function peekTicket(ticket) {
  if (!ticket) return null;
  const r = await fetch(RENDER_PEEK_ENDPOINT + "?ticket=" + encodeURIComponent(ticket));
  const j = await r.json();
  if (!r.ok) throw new Error(j.error || r.statusText);
  return { fileName: j.fileName || "", type: (j.type || "text").toLowerCase() };
}

(async function initPeek(){
  try {
    if (T_EML) {
      const pe = await peekTicket(T_EML);
      document.getElementById("nm_eml").textContent = `â†’ ${pe.fileName || "(åå‰æœªè¨­å®š)"} [${pe.type}]`;
      // ä¾¿åˆ©ã®ãŸã‚ã€emlã®ã¿æ‹¡å¼µå­è£œæ­£
      if (pe.type === "eml") {
        const current = document.getElementById("name").value.trim();
        const isDefaultSuggest = (SUGGEST === "download.txt" || current === "" || current === SUGGEST);
        if (isDefaultSuggest && pe.fileName) document.getElementById("name").value = pe.fileName;
        const nm = document.getElementById("name").value.trim() || "message.eml";
        document.getElementById("name").value = nm.toLowerCase().endsWith(".eml") ? nm : (nm + ".eml");
      }
    }
    if (T_MSG) {
      const pm = await peekTicket(T_MSG);
      document.getElementById("nm_msg").textContent = `â†’ ${pm.fileName || "(åå‰æœªè¨­å®š)"} [${pm.type}]`;
      // æ·»ä»˜Excelåã¯ .msg ã‚’é–‹ãã¾ã§ç¢ºå®šã—ãªã„ã®ã§ã“ã“ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è¡¨ç¤º
      document.getElementById("nm_xlsx").textContent = "â†’ ï¼ˆ.msgå†…ã®æœ€åˆã®Excelã‚’ä¿å­˜ï¼‰";
    }

    // å˜ä½“äº’æ›ï¼ˆ?ticket=... ã®ã¿æ¸¡ã•ã‚ŒãŸå ´åˆã¯ 1) ã«å‰²å½“ï¼‰
    if (!T_EML && !T_MSG && TICKET_SINGLE) {
      const p1 = await peekTicket(TICKET_SINGLE);
      document.getElementById("nm_eml").textContent = `â†’ ${p1.fileName || "(åå‰æœªè¨­å®š)"} [${p1.type}]`;
      document.getElementById("cb_eml").checked = true;
    }
  } catch(e) {
    log("peekä¾‹å¤–: " + e.message);
  }
})();

// ãƒ•ã‚©ãƒ«ãƒ€é¸æŠï¼ˆæ—¢å­˜ã®å‹•ç·šã®ã¾ã¾ï¼‰
document.getElementById("pick").onclick = () => {
  if (!FRONT_CLIENT_ID) { alert("FRONT_CLIENT_ID ãŒæœªè¨­å®šã§ã™"); return; }
  const odOptions = {
    clientId: FRONT_CLIENT_ID,
    action: "query",
    viewType: "folders",
    multiSelect: false,
    openInNewWindow: true,
    advanced: {
      endpointHint: "api.onedrive.com",
      redirectUri: location.origin + "/picker-redirect.html"
    },
    success: async function(res) {
      const it = (res.value && res.value[0]) || null;
      if (!it || !it.id || !it.folder) { log("âŒ ãƒ•ã‚©ãƒ«ãƒ€ãŒé¸æŠã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"); return; }
      pickedFolderId = it.id;

      let label = "";
      try {
        const r = await fetch(RENDER_BASE + "/api/drive/item?id=" + encodeURIComponent(it.id));
        const meta = await r.json();
        if (r.ok && meta.name) {
          label = meta.name;
          if (meta.webUrl) {
            const a = document.createElement("a");
            a.href = meta.webUrl; a.textContent = "é¸æŠãƒ•ã‚©ãƒ«ãƒ€ã‚’OneDriveã§é–‹ã"; a.target = "_blank";
            document.getElementById("log").appendChild(a);
            document.getElementById("log").appendChild(document.createTextNode("\n"));
          }
        } else {
          label = "ID:" + String(it.id).slice(0, 8) + "â€¦";
        }
      } catch (e) {
        label = "ID:" + String(it.id).slice(0, 8) + "â€¦";
      }

      hint("é¸æŠä¸­: " + label);
      log("Pick OK: folderId=" + pickedFolderId);
      document.getElementById("upload").disabled = false;
    },
    cancel: function(){ log("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ"); },
    error: function(e){ log("ã‚¨ãƒ©ãƒ¼: " + JSON.stringify(e)); }
  };
  OneDrive.open(odOptions);
};

// å…±é€šPOST
async function uploadOne(endpoint, ticket, nameOverride) {
  const fd = new FormData();
  fd.append("ticket", ticket);
  fd.append("folderId", pickedFolderId);
  if (nameOverride) fd.append("fileName", nameOverride);
  const r = await fetch(endpoint, { method: "POST", body: fd });
  const j = await r.json().catch(()=> ({}));
  return { ok: r.ok, status: r.status, body: j };
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
document.getElementById("upload").onclick = async () => {
  if (!pickedFolderId) { alert("å…ˆã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }

  // é€ã‚‹å¯¾è±¡ã‚’åé›†
  const want_eml  = document.getElementById("cb_eml").checked && (T_EML || TICKET_SINGLE);
  const want_xlsx = document.getElementById("cb_xlsx").checked && T_MSG;  // .msg å†…ã® Excel ã‚’æ–°APIã¸
  const want_msg  = document.getElementById("cb_msg").checked && T_MSG;   // .msg åŸæ–‡ã¯å¾“æ¥APIã¸

  if (!want_eml && !want_xlsx && !want_msg) {
    alert("ä¿å­˜ã™ã‚‹é …ç›®ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„");
    return;
  }

  let nm = (document.getElementById("name").value || SUGGEST).trim();
  // eml ã®æ™‚ã ã‘æ‹¡å¼µå­è£œæ­£ï¼ˆä»»æ„ï¼‰
  if (want_eml && nm && !nm.toLowerCase().endsWith(".eml")) {
    nm = nm + ".eml";
    document.getElementById("name").value = nm;
  }

  document.getElementById("upload").disabled = true;
  try {
    // 1) .emlï¼ˆå˜ä½“äº’æ›ã‚’å„ªå…ˆï¼‰
    if (want_eml) {
      const ticket = T_EML || TICKET_SINGLE;
      log(`â†’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: .eml`);
      const r = await uploadOne(RENDER_UPLOAD_ENDPOINT, ticket, nm || undefined);
      if (r.ok) {
        log(`âœ… å®Œäº†(.eml): ${r.body.webUrl || ""}`);
        if (r.body.webUrl) {
          const a = document.createElement("a");
          a.href = r.body.webUrl; a.textContent = r.body.name || "OneDriveã§é–‹ã"; a.target = "_blank";
          document.getElementById("log").appendChild(a);
          document.getElementById("log").appendChild(document.createTextNode("\n"));
        }
      } else {
        log(`âŒ å¤±æ•—(.eml): ${r.status} ${JSON.stringify(r.body)}`);
      }
    }

    // 2) æ·»ä»˜Excelï¼ˆ.msg â†’ ExcelæŠ½å‡ºAPIï¼‰
    if (want_xlsx) {
      log(`â†’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: .msgå†…Excel`);
      const r = await uploadOne(RENDER_UPLOAD_MSG_XLSX_EP, T_MSG, undefined /* nameã¯æ·»ä»˜åã‚’å„ªå…ˆ */);
      if (r.ok) {
        log(`âœ… å®Œäº†(Excel): ${r.body.webUrl || ""}`);
        if (r.body.webUrl) {
          const a = document.createElement("a");
          a.href = r.body.webUrl; a.textContent = r.body.name || "OneDriveã§é–‹ã"; a.target = "_blank";
          document.getElementById("log").appendChild(a);
          document.getElementById("log").appendChild(document.createTextNode("\n"));
        }
      } else {
        log(`âŒ å¤±æ•—(Excel): ${r.status} ${JSON.stringify(r.body)}`);
      }
    }

    // 3) .msg åŸæ–‡ï¼ˆå¾“æ¥APIï¼‰
    if (want_msg) {
      log(`â†’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: .msg åŸæ–‡`);
      const r = await uploadOne(RENDER_UPLOAD_ENDPOINT, T_MSG, undefined /* nameä¸Šæ›¸ãã—ãŸã„ãªã‚‰ã“ã“ã§æ¸¡ã™ */);
      if (r.ok) {
        log(`âœ… å®Œäº†(.msg): ${r.body.webUrl || ""}`);
        if (r.body.webUrl) {
          const a = document.createElement("a");
          a.href = r.body.webUrl; a.textContent = r.body.name || "OneDriveã§é–‹ã"; a.target = "_blank";
          document.getElementById("log").appendChild(a);
          document.getElementById("log").appendChild(document.createTextNode("\n"));
        }
      } else {
        log(`âŒ å¤±æ•—(.msg): ${r.status} ${JSON.stringify(r.body)}`);
      }
    }

  } catch(e) {
    log("âŒ ä¾‹å¤–: " + e.message);
  } finally {
    document.getElementById("upload").disabled = false;
  }
};
</script>