<!doctype html>
<meta charset="utf-8" />
<title>OneDriveï¼ˆå€‹äººï¼‰ã«ä¿å­˜</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font:14px/1.6 system-ui; max-width:780px; margin:24px auto; }
  .row { display:flex; gap:8px; margin:10px 0; align-items:center; flex-wrap:wrap; }
  input[type=text]{ flex:1; padding:8px; }
  button { padding:10px 12px; border:1px solid #ccc; border-radius:10px; cursor:pointer; }
  #log { white-space:pre-wrap; background:#fafafa; border:1px solid #eee; padding:12px; min-height:80px;}
</style>

<h1>OneDriveï¼ˆå€‹äººï¼‰ã«ä¿å­˜</h1>
<p>1) ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã‚“ã§ â†’ 2) ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>

<div class="row">
  <label>ãƒ•ã‚¡ã‚¤ãƒ«å</label>
  <input id="name" type="text" placeholder="Report.txt">
</div>

<div class="row">
  <button id="pick">ğŸ“ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã¶</button>
  <span id="pickedHint"></span>
</div>

<div class="row">
  <button id="upload" disabled>â¬† ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
</div>

<h3>ãƒ­ã‚°</h3>
<pre id="log"></pre>

<!-- OneDrive File Picker v7.2 -->
<script src="https://js.live.net/v7.2/OneDrive.js"></script>
<script>
const q = new URLSearchParams(location.search);
const TICKET  = q.get("ticket") || "";
const SUGGEST = q.get("suggest") || "download.txt";
document.getElementById("name").value = SUGGEST;

// â˜…æœ¬ç•ªå€¤ï¼ˆRenderã®Flask URL ã¨ OneDrive Pickerã®ã‚¢ãƒ—ãƒªIDï¼‰
const RENDER_BASE = "https://ai-az.onrender.com";                 // â† æŒ‡å®šã©ãŠã‚Šå›ºå®š
const FRONT_CLIENT_ID = "YOUR_ONEDRIVE_PICKER_APP_ID";            // â† ã‚ãªãŸã®ã‚¢ãƒ—ãƒªIDã«ç½®æ›
const RENDER_UPLOAD_ENDPOINT = RENDER_BASE + "/api/upload";
const RENDER_PEEK_ENDPOINT   = RENDER_BASE + "/tickets/peek";

let pickedFolderId = null;
let payloadType = "text"; // peekã§ä¸Šæ›¸ãäºˆå®š

const log  = (m)=> document.getElementById("log").textContent += m + "\n";
const hint = (m)=> document.getElementById("pickedHint").textContent = m;

// 1) åˆæœŸè¡¨ç¤ºæ™‚ã« /tickets/peek ã§ã‚µãƒ¼ãƒå´ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å‚ç…§ã—ã€å…¥åŠ›æ¬„ã«åæ˜ 
(async function initNameFromPeek(){
  if (!TICKET) { log("âš  ticket ãŒã‚¯ã‚¨ãƒªã«ãªãåˆæœŸåã¯ suggest ã®ã¾ã¾ã§ã™"); return; }
  try {
    const r = await fetch(RENDER_PEEK_ENDPOINT + "?ticket=" + encodeURIComponent(TICKET));
    const j = await r.json();
    if (!r.ok) { log("peekå¤±æ•—: " + (j.error || r.statusText)); return; }
    payloadType = (j.type || "text").toLowerCase();

    const current = document.getElementById("name").value.trim();
    const isDefaultSuggest = (SUGGEST === "download.txt" || current === "" || current === SUGGEST);

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ suggest ãªã‚‰ã€peek ã® fileName ã‚’å„ªå…ˆ
    if (isDefaultSuggest && j.fileName) {
      document.getElementById("name").value = j.fileName;
    }

    // eml ã®å ´åˆã¯å¿µã®ãŸã‚æ‹¡å¼µå­ã‚’æ•´ãˆã‚‹
    if (payloadType === "eml") {
      const nm = document.getElementById("name").value.trim() || "message.eml";
      document.getElementById("name").value = nm.toLowerCase().endsWith(".eml") ? nm : (nm + ".eml");
    }
  } catch (e) {
    log("peekä¾‹å¤–: " + e.message);
  }
})();

// 2) ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ
document.getElementById("pick").onclick = () => {
  if (!FRONT_CLIENT_ID) { alert("FRONT_CLIENT_ID ãŒæœªè¨­å®šã§ã™"); return; }
  const odOptions = {
    clientId: FRONT_CLIENT_ID,
    action: "query",           // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆIDï¼‰å–å¾—
    viewType: "folders",       // ãƒ•ã‚©ãƒ«ãƒ€ã®ã¿
    multiSelect: false,
    openInNewWindow: true,
    advanced: {
      endpointHint: "api.onedrive.com",
      // redirectUri: location.origin + "/picker-redirect.html" // å¿…è¦æ™‚ã«è¨­å®š
    },
    success: async function(res) {
      const it = (res.value && res.value[0]) || null;
      if (!it || !it.id || !it.folder) { log("âŒ ãƒ•ã‚©ãƒ«ãƒ€ãŒé¸æŠã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"); return; }
      pickedFolderId = it.id; // /me/drive/items/{id} ã® {id}

      // Graph API ã§ name/webUrl ã‚’å¼•ãï¼ˆå¿…ãšãƒ•ã‚©ãƒ«ãƒ€åã‚’è¡¨ç¤ºã—ãŸã„ï¼‰
      let label = "";
      try {
        const r = await fetch(RENDER_BASE + "/api/drive/item?id=" + encodeURIComponent(it.id));
        const meta = await r.json();
        if (r.ok && meta.name) {
          label = meta.name;
          // ä»»æ„ï¼šãƒ­ã‚°ã«é–‹ããƒªãƒ³ã‚¯
          if (meta.webUrl) {
            const a = document.createElement("a");
            a.href = meta.webUrl; a.textContent = "é¸æŠãƒ•ã‚©ãƒ«ãƒ€ã‚’OneDriveã§é–‹ã"; a.target = "_blank";
            document.getElementById("log").appendChild(a);
            document.getElementById("log").appendChild(document.createTextNode("\n"));
          }
        } else {
          label = "ID:" + String(it.id).slice(0, 8) + "â€¦";
        }
      } catch (e) {
        label = "ID:" + String(it.id).slice(0, 8) + "â€¦";
      }

      hint("é¸æŠä¸­: " + label);
      log("Pick OK: folderId=" + pickedFolderId);
      document.getElementById("upload").disabled = false;
    },
    cancel: function(){ log("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ"); },
    error: function(e){ log("ã‚¨ãƒ©ãƒ¼: " + JSON.stringify(e)); }
  };
  OneDrive.open(odOptions);
};

// 3) ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
document.getElementById("upload").onclick = async () => {
  if (!TICKET) { alert("ticket ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  if (!pickedFolderId) { alert("å…ˆã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }

  // eml ã®å ´åˆã¯æ‹¡å¼µå­ã‚’å¼·åˆ¶çš„ã«æ•´ãˆã‚‹ï¼ˆã†ã£ã‹ã‚Š.txtã§ã‚‚ä¿®æ­£ï¼‰
  let nm = (document.getElementById("name").value || SUGGEST).trim();
  if (payloadType === "eml" && nm && !nm.toLowerCase().endsWith(".eml")) {
    nm = nm + ".eml";
    document.getElementById("name").value = nm;
  }

  const fd = new FormData();
  fd.append("ticket", TICKET);
  fd.append("folderId", pickedFolderId);
  if (nm) fd.append("fileName", nm);

  try {
    log("â†’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹");
    document.getElementById("upload").disabled = true;
    const r = await fetch(RENDER_UPLOAD_ENDPOINT, { method:"POST", body: fd });
    const j = await r.json().catch(()=> ({}));
    document.getElementById("upload").disabled = false;
    if (r.ok) {
      log("âœ… å®Œäº†: " + (j.webUrl || "(URLãªã—)"));
      if (j.webUrl) {
        const a = document.createElement("a");
        a.href = j.webUrl; a.textContent = "OneDriveã§é–‹ã";
        a.target = "_blank";
        document.getElementById("log").appendChild(a);
        document.getElementById("log").appendChild(document.createTextNode("\n"));
      }
    } else {
      log("âŒ å¤±æ•—: " + (j.error || r.statusText) + "\n" + (j.detail || ""));
    }
  } catch (e) {
    log("âŒ ä¾‹å¤–: " + e.message);
    document.getElementById("upload").disabled = false;
  }
};
</script>
